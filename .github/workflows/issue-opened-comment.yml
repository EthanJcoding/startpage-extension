name: Issue Opened Worker Trigger

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: issue-opened-worker-${{ github.repository }}-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  run-codex-worker:
    name: Run Codex worker for opened issue
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      BASE_BRANCH: ${{ github.event.repository.default_branch }}
      CODEX_WORKER_IMAGE: ${{ vars.CODEX_WORKER_IMAGE }}
    steps:
      - name: Validate required configuration
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "Missing required secret: OPENAI_API_KEY"
            exit 1
          fi
          if [ "${#OPENAI_API_KEY}" -lt 20 ]; then
            echo "OPENAI_API_KEY looks too short (length check failed)."
            exit 1
          fi
          if [ -z "${CODEX_WORKER_IMAGE}" ]; then
            echo "Missing required repository variable: CODEX_WORKER_IMAGE"
            echo "Example: ghcr.io/<org>/<image>:latest"
            exit 1
          fi

      - name: Pull worker image
        run: docker pull "${CODEX_WORKER_IMAGE}"

      - name: Run worker with dynamic issue number
        timeout-minutes: 25
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker run --rm \
            -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
            -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            -e ISSUE_NUMBER="${ISSUE_NUMBER}" \
            -e BASE_BRANCH="${BASE_BRANCH}" \
            -e VERIFY_CMD="npm run build" \
            -e CI=true \
            "${CODEX_WORKER_IMAGE}"

      - name: Comment when worker fails
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.payload.issue.number,
              body: [
                'Codex worker failed for this issue.',
                '',
                `- Worker image: \`${process.env.CODEX_WORKER_IMAGE || 'not-set'}\``,
                `- Base branch: \`${process.env.BASE_BRANCH || 'unknown'}\``,
                '',
                'Please check Actions logs and worker image configuration.',
              ].join('\n'),
            });
